on:
  push:
    branches: [ dev ]

env:
  REGISTRY_URL: harbor.gcro.gmc.bt
  REPO: dev-doi
  IMAGE: gcro-client
  NAMESPACE: dev
  REGISTRY_USERNAME: admin
  REGISTRY_SECRET: registry-secret
  APP_ENV: dev-gcro-client-env

jobs:
  build:
    name: Build, push, and deploy to Development Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout production
        uses: actions/checkout@v4

      # keep ONLY if DNS for harbor.gcro.gmc.bt doesn't resolve publicly yet
      - name: Add host to /etc/hosts
        run: |
          echo "103.252.84.40 harbor.gcro.gmc.bt" | sudo tee -a /etc/hosts

      - name: Login to Container Registry (Harbor via HTTPS)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_ACCESS_SECRET }}

      - name: Build container image
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | head -c7)
          docker build --no-cache -t $REGISTRY_URL/$REPO/$IMAGE:$SHORT_SHA -f Dockerfile .

      - name: Push image to Harbor Container Registry
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | head -c7)
          docker push $REGISTRY_URL/$REPO/$IMAGE:$SHORT_SHA

      - name: Update Deployment file
        run: |
          TAG=$(echo $GITHUB_SHA | head -c7)
          sed -i "s|<IMAGE>|$REGISTRY_URL/$REPO/$IMAGE:$TAG|g" $GITHUB_WORKSPACE/deployment-dev.yaml
          sed -i "s|<NAMESPACE>|$NAMESPACE|g" $GITHUB_WORKSPACE/deployment-dev.yaml
          sed -i "s|<REGISTRY_SECRET>|$REGISTRY_SECRET|g" $GITHUB_WORKSPACE/deployment-dev.yaml
          sed -i "s|<APP_ENV>|$APP_ENV|g" $GITHUB_WORKSPACE/deployment-dev.yaml
          # Replace tag placeholder that I left in the image above
          sed -i "s|<TAG_REPLACED_BY_CI>|$TAG|g" $GITHUB_WORKSPACE/deployment-dev.yaml

      - name: Deploy to Kubernetes Cluster
        uses: steebchen/kubectl@v2.0.0
        with:
          config: ${{ secrets.KUBE_CONFIG_GDC }}
          command: apply -f $GITHUB_WORKSPACE/deployment-dev.yaml

      - name: Verify Deployment
        uses: steebchen/kubectl@v2.0.0
        with:
          config: ${{ secrets.KUBE_CONFIG_GDC }}
          command: rollout status deployment/$IMAGE -n $NAMESPACE
